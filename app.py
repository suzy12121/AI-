# -*- coding: utf-8 -*-
"""0518 AI æ¨¡æ“¬ç”Ÿæˆå™¨.ipynb

Automatically generated by Colab.

Original file is located at
    https://colab.research.google.com/drive/1EDCNLZK8iTqDyZJ8ADdqQCrtn5UC1a_0
"""


import fitz  # PyMuPDF
from flask import Flask, request, render_template
import fitz  # pymupdf
import os
from openai import OpenAI

app = Flask(__name__)

# Load OpenAI key from env
client = OpenAI(api_key=os.environ.get("OPENAI_API_KEY"))

@app.route('/')
def index():
    return render_template('index.html')

@app.route('/upload', methods=['POST'])
def upload():
    pdf_file = request.files['pdf']
    text = ""
    with fitz.open(stream=pdf_file.read(), filetype="pdf") as doc:
        for page in doc:
            text += page.get_text()

    # Generate MCQs with OpenAI here...
    # response = client.chat.completions.create(...) etc.

    return f"<pre>{text[:1000]}</pre>"  # For now, just preview text

import os

if __name__ == '__main__':
    app.run(host='0.0.0.0', port=int(os.environ.get('PORT', 5000)))


# Upload PDF
uploaded = files.upload()

# Extract Traditional Chinese text
pdf_text = ""
for filename in uploaded:
    with fitz.open(filename) as doc:
        for page in doc:
            pdf_text += page.get_text()

# Optional: truncate to stay within token limit
input_text = pdf_text[:3000]

import os
from openai import OpenAI

client = OpenAI(api_key=os.environ.get("OPENAI_API_KEY"))


prompt = f"""
æ ¹æ“šä»¥ä¸‹ç¹é«”ä¸­æ–‡å…§å®¹ï¼Œè«‹ç”Ÿæˆä¸‰é¡Œé¸æ“‡é¡Œï¼Œæ¯é¡ŒåŒ…å«ä»¥ä¸‹æ ¼å¼ï¼Œä¸¦ä»¥ç¹é«”ä¸­æ–‡å›ç­”ï¼š

---
å•é¡Œï¼š<ä½ çš„å•é¡Œ>
Aï¼š<é¸é …A>
Bï¼š<é¸é …B>
Cï¼š<é¸é …C>
Dï¼š<é¸é …D>
ç­”æ¡ˆï¼š<æ­£ç¢ºé¸é …ï¼ˆåƒ…å¡« Aã€Bã€C æˆ– Dï¼‰>
---

è«‹å‹™å¿…ä½¿ç”¨ä¸Šè¿°æ ¼å¼ï¼Œä¸è¦åŠ å…¥å¤šé¤˜çš„èªªæ˜æˆ–æ¨™é¡Œã€‚

ä»¥ä¸‹æ˜¯å…§å®¹ï¼š
{input_text}
"""

response = client.chat.completions.create(
    model="gpt-4",
    messages=[{"role": "user", "content": prompt}],
    temperature=0.7,
)

generated_text = response.choices[0].message.content
print("ğŸ“ GPT å›å‚³å…§å®¹ï¼š\n", generated_text)

# --- Parse into structured MCQs ---
def parse_mcqs(text):
    questions = []
    blocks = text.strip().split("\n\n")
    for block in blocks:
        lines = block.strip().split("\n")
        q = {}
        for line in lines:
            if line.startswith("å•é¡Œï¼š"):
                q["å•é¡Œ"] = line.replace("å•é¡Œï¼š", "").strip()
            elif line.startswith("Aï¼š"):
                q["A"] = line.replace("Aï¼š", "").strip()
            elif line.startswith("Bï¼š"):
                q["B"] = line.replace("Bï¼š", "").strip()
            elif line.startswith("Cï¼š"):
                q["C"] = line.replace("Cï¼š", "").strip()
            elif line.startswith("Dï¼š"):
                q["D"] = line.replace("Dï¼š", "").strip()
            elif line.startswith("ç­”æ¡ˆï¼š"):
                q["ç­”æ¡ˆ"] = line.replace("ç­”æ¡ˆï¼š", "").strip()
        if len(q) == 6:
            questions.append(q)
    return questions

questions = parse_mcqs(generated_text)

import json
import os
import gspread
from google.oauth2.service_account import Credentials

SCOPES = ["https://www.googleapis.com/auth/spreadsheets"]

# Load credentials from env variable
service_account_info = json.loads(os.environ.get("GOOGLE_SERVICE_ACCOUNT_JSON"))
creds = Credentials.from_service_account_info(service_account_info, scopes=SCOPES)

gc = gspread.authorize(creds)



# Open your Google Spreadsheet
sheet = gc.open('å•é¡Œç”Ÿæˆå™¨').sheet1  # Must exist

# Write questions
start_row = 2
for i, q in enumerate(questions):
    row = start_row + i
    row_data = [
        q["å•é¡Œ"],
        q["A"],
        q["B"],
        q["C"],
        q["D"],
        q["ç­”æ¡ˆ"]
    ]
    sheet.update(f"A{row}:F{row}", [row_data])

print("âœ… å·²æˆåŠŸå¯«å…¥ Google è©¦ç®—è¡¨")
